<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ObligatorioTT.Views.PeliculasPage"
             Title="Próximos estrenos"
             BackgroundColor="{StaticResource FondoOscuro}">

    <!-- Estilos locales -->
    <ContentPage.Resources>
        <ResourceDictionary>
            <Color x:Key="CardBg">#0F1A2A</Color>
            <Color x:Key="CardBgAlt">#122033</Color>
            <Color x:Key="TextPrimary">#FFFFFF</Color>
            <Color x:Key="TextSecondary">#94A3B8</Color>
            <Color x:Key="AccentBlue">#3B82F6</Color>
            <Color x:Key="AccentCyan">#06B6D4</Color>

            <Style TargetType="Label" x:Key="TitleLabel">
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="FontSize" Value="18" />
                <Setter Property="TextColor" Value="{StaticResource TextPrimary}" />
                <Setter Property="LineBreakMode" Value="TailTruncation" />
                <Setter Property="MaxLines" Value="1" />
            </Style>

            <Style TargetType="Label" x:Key="BodyLabel">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="TextColor" Value="{StaticResource TextSecondary}" />
                <Setter Property="LineBreakMode" Value="WordWrap" />
                <Setter Property="MaxLines" Value="4" />
            </Style>

            <Style TargetType="Frame" x:Key="Card">
                <Setter Property="CornerRadius" Value="16" />
                <Setter Property="Padding" Value="12" />
                <Setter Property="HasShadow" Value="True" />
                <Setter Property="BackgroundColor" Value="{StaticResource CardBg}" />
                <Setter Property="Margin" Value="0,0,0,16" />
                <Setter Property="Shadow">
                    <Setter.Value>
                        <Shadow Brush="Black" Opacity="0.35" Radius="14" />
                    </Setter.Value>
                </Setter>
            </Style>

            <Style TargetType="Button" x:Key="PillButton">
                <Setter Property="CornerRadius" Value="18"/>
                <Setter Property="Padding" Value="14,8"/>
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="BackgroundColor" Value="{StaticResource AccentBlue}"/>
            </Style>

            <Style TargetType="Picker" x:Key="PickerStyle">
                <Setter Property="TextColor" Value="{StaticResource TextPrimary}" />
                <Setter Property="BackgroundColor" Value="{StaticResource CardBgAlt}" />
                <Setter Property="HorizontalOptions" Value="FillAndExpand" />
                <Setter Property="HeightRequest" Value="44" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <!-- Contenido principal -->
        <ScrollView>
            <VerticalStackLayout Padding="15" Spacing="15">

                <Label Text="Filtrar por género"
                       FontAttributes="Bold"
                       FontSize="18"
                       TextColor="{StaticResource TextPrimary}" />

                <Picker x:Name="pickerGeneros"
                        Style="{StaticResource PickerStyle}"
                        Title="Todos"
                        SelectedIndexChanged="pickerGeneros_SelectedIndexChanged" />

                <CollectionView x:Name="PeliculasView"
                                ItemsSource="{Binding Peliculas}"
                                ItemSizingStrategy="MeasureAllItems"
                                Margin="0,10">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="16" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <!-- Card contenedora -->
                            <Grid Padding="0">
                                <Frame Style="{StaticResource Card}">
                                    <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                                          ColumnDefinitions="*">

                                        <!-- Portada con esquinas redondeadas -->
                                        <Border StrokeShape="RoundRectangle 12">
                                            <Grid HeightRequest="220">
                                                <!-- Imagen -->
                                                <Image Source="{Binding PosterUrl}"
                                                       Aspect="AspectFill"
                                                       HorizontalOptions="Fill"
                                                       VerticalOptions="Fill" />
                                                <!-- Placeholder si no hay poster -->
                                                <Grid InputTransparent="True"
                                                      IsVisible="False">
                                                    <Grid.Triggers>
                                                        <DataTrigger TargetType="Grid"
                                                                     Binding="{Binding PosterUrl}"
                                                                     Value="">
                                                            <Setter Property="IsVisible" Value="True"/>
                                                        </DataTrigger>
                                                        <DataTrigger TargetType="Grid"
                                                                     Binding="{Binding PosterUrl}"
                                                                     Value="{x:Null}">
                                                            <Setter Property="IsVisible" Value="True"/>
                                                        </DataTrigger>
                                                    </Grid.Triggers>
                                                    <Grid.Background>
                                                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                            <GradientStop Color="#1B2940" Offset="0"/>
                                                            <GradientStop Color="#0F1A2A" Offset="1"/>
                                                        </LinearGradientBrush>
                                                    </Grid.Background>
                                                    <Label Text="Sin imagen"
                                                           HorizontalOptions="Center"
                                                           VerticalOptions="Center"
                                                           TextColor="{StaticResource TextSecondary}"/>
                                                </Grid>
                                            </Grid>
                                        </Border>

                                        <!-- Título -->
                                        <Label Grid.Row="1"
                                               Text="{Binding Titulo}"
                                               Style="{StaticResource TitleLabel}"
                                               Margin="0,10,0,2" />

                                        <!-- Descripción -->
                                        <Label Grid.Row="2"
                                               Text="{Binding Descripcion}"
                                               Style="{StaticResource BodyLabel}" />

                                        <!-- Acciones -->
                                        <Grid Grid.Row="3"
                                              ColumnDefinitions="Auto,*,Auto"
                                              Margin="0,12,0,0">
                                            <Button Text="▶ Ver tráiler"
                                                    Style="{StaticResource PillButton}"
                                                    Clicked="OnPlayButtonClicked"
                                                    HorizontalOptions="Start" />
                                            <Label Grid.Column="2"
                                                   Text="Tocar para expandir"
                                                   TextColor="{StaticResource TextSecondary}"
                                                   FontSize="12"
                                                   VerticalTextAlignment="Center" />
                                        </Grid>

                                        <!-- Overlay decorativo sutil -->
                                        <Grid Grid.RowSpan="4"
                                              InputTransparent="True"
                                              ZIndex="10">
                                            <Grid.Background>
                                                <LinearGradientBrush StartPoint="0,1" EndPoint="0,0">
                                                    <GradientStop Color="#00000000" Offset="0.0" />
                                                    <GradientStop Color="#00000020" Offset="1.0" />
                                                </LinearGradientBrush>
                                            </Grid.Background>
                                        </Grid>
                                    </Grid>
                                </Frame>

                                <!-- Animación + tap en toda la card -->
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="OnCardTapped" />
                                </Grid.GestureRecognizers>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>

        <!-- OVERLAY de DETALLE (misma página) -->
        <Grid x:Name="DetailsOverlay"
              IsVisible="False"
              BackgroundColor="#CC000000"
              Padding="16"
              RowDefinitions="Auto,*"
              ZIndex="1000">

            <!-- Barra superior -->
            <Grid ColumnDefinitions="*,Auto" Padding="0,8">
                <Label Text="Detalle"
                       TextColor="White"
                       FontAttributes="Bold"
                       FontSize="18"
                       VerticalTextAlignment="Center"/>
                <Button Text="✕"
                        Clicked="CloseDetails"
                        BackgroundColor="#333333"
                        TextColor="White"
                        Padding="12,8"
                        CornerRadius="10"
                        Grid.Column="1"/>
            </Grid>

            <!-- Contenido -->
            <ScrollView Grid.Row="1">
                <Frame x:Name="DetailsCard"
                       BackgroundColor="{StaticResource CardBg}"
                       CornerRadius="16"
                       HasShadow="True"
                       Padding="12">
                    <VerticalStackLayout Spacing="12">

                        <!-- Póster a ancho completo -->
                        <Border StrokeShape="RoundRectangle 16">
                            <Image x:Name="DetailsPoster"
                                   Aspect="AspectFill"
                                   HeightRequest="360"
                                   HorizontalOptions="Fill"
                                   VerticalOptions="Fill"/>
                        </Border>

                        <!-- Título -->
                        <Label x:Name="DetailsTitle"
                               TextColor="White"
                               FontAttributes="Bold"
                               FontSize="22"
                               LineBreakMode="TailTruncation"
                               MaxLines="2"/>

                        <!-- Fecha -->
                        <Label>
                            <Label.FormattedText>
                                <FormattedString>
                                    <Span Text="Fecha de lanzamiento: " TextColor="#94A3B8"/>
                                    <Span x:Name="DetailsDate" TextColor="White"/>
                                </FormattedString>
                            </Label.FormattedText>
                        </Label>

                        <!-- Sinopsis -->
                        <Label Text="Sinopsis" TextColor="White" FontAttributes="Bold" FontSize="18"/>
                        <Label x:Name="DetailsOverview"
                               TextColor="#E5E7EB"
                               FontSize="16"/>

                    </VerticalStackLayout>
                </Frame>
            </ScrollView>
        </Grid>

    </Grid>
</ContentPage>